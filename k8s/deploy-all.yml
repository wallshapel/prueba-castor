# ============================================
# SECRETS
# ============================================
---
apiVersion: v1
kind: Secret
metadata:
  name: postgresql-secret
  namespace: default
type: Opaque
stringData:
  POSTGRES_USER: "castor_user"
  POSTGRES_PASSWORD: "Castor2025*"

---
apiVersion: v1
kind: Secret
metadata:
  name: oracle-secret
  namespace: default
type: Opaque
stringData:
  ORACLE_PASSWORD: "Castor2025*"
  ORACLE_USER: "CASTOR_BILLING"
  ORACLE_USER_PASSWORD: "Castor2025*"

# ============================================
# CONFIGMAPS
# ============================================
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: billing-service-config
  namespace: default
data:
  POSTGRES_HOST: "postgresql"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "castor_customers"

  ORACLE_HOST: "oracle-db"
  ORACLE_PORT: "1521"
  ORACLE_PDB: "XEPDB1"

  PYTHON_CALCULATOR_URL: "http://invoice-calculator:5001/calculate"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: oracle-init-sql
  namespace: default
data:
  init.sql: |
    ALTER SESSION SET "_ORACLE_SCRIPT" = true;

    CREATE USER CASTOR_BILLING IDENTIFIED BY "Castor2025*";

    GRANT CONNECT, RESOURCE, CREATE SESSION, CREATE TABLE, CREATE VIEW, CREATE SEQUENCE,
          CREATE TRIGGER, CREATE PROCEDURE, CREATE SYNONYM TO CASTOR_BILLING;

    ALTER USER CASTOR_BILLING QUOTA UNLIMITED ON USERS;

# ============================================
# PVC (SOLO ORACLE)
# ============================================
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: oracle-pvc
  namespace: default
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 5Gi

# ============================================
# STATEFULSET — SOLO ORACLE (PostgreSQL está separado)
# ============================================
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: oracle-db
  namespace: default
spec:
  serviceName: oracle-db
  replicas: 1
  selector:
    matchLabels:
      app: oracle-db
  template:
    metadata:
      labels:
        app: oracle-db
    spec:
      containers:
        - name: oracle
          image: gvenzl/oracle-xe:latest
          ports:
            - containerPort: 1521
          env:
            - name: ORACLE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: oracle-secret
                  key: ORACLE_PASSWORD
            - name: APP_USER
              valueFrom:
                secretKeyRef:
                  name: oracle-secret
                  key: ORACLE_USER
            - name: APP_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: oracle-secret
                  key: ORACLE_USER_PASSWORD
          volumeMounts:
            - name: oracle-data
              mountPath: /opt/oracle/oradata
            - name: init-sql
              mountPath: /docker-entrypoint-initdb.d
      volumes:
        - name: init-sql
          configMap:
            name: oracle-init-sql
  volumeClaimTemplates:
    - metadata:
        name: oracle-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 5Gi

# ============================================
# DEPLOYMENTS
# ============================================
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: billing-service
  namespace: default
  labels:
    app: billing-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: billing-service
  template:
    metadata:
      labels:
        app: billing-service
    spec:
      containers:
        - name: billing-service
          image: billing-service:latest
          imagePullPolicy: Never
          ports:
            - containerPort: 8081
          envFrom:
            - configMapRef:
                name: billing-service-config
            - secretRef:
                name: billing-service-secret

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: invoice-calculator
  namespace: default
  labels:
    app: invoice-calculator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: invoice-calculator
  template:
    metadata:
      labels:
        app: invoice-calculator
    spec:
      containers:
        - name: invoice-calculator
          image: invoice-calculator:latest
          imagePullPolicy: Never
          ports:
            - containerPort: 5001

# ============================================
# SERVICES
# ============================================
---
apiVersion: v1
kind: Service
metadata:
  name: billing-service
  namespace: default
spec:
  type: NodePort
  selector:
    app: billing-service
  ports:
    - port: 8081
      targetPort: 8081
      nodePort: 30081

---
apiVersion: v1
kind: Service
metadata:
  name: invoice-calculator
  namespace: default
spec:
  type: ClusterIP
  selector:
    app: invoice-calculator
  ports:
    - port: 5001
      targetPort: 5001

---
apiVersion: v1
kind: Service
metadata:
  name: oracle-db
  namespace: default
spec:
  type: ClusterIP
  selector:
    app: oracle-db
  ports:
    - port: 1521
      targetPort: 1521
