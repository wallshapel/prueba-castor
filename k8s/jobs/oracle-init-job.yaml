# k8s/jobs/oracle-init-job.yaml

apiVersion: batch/v1
kind: Job
metadata:
  name: oracle-init-job
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: oracle-init
        image: gvenzl/oracle-xe:latest
        command:
          - /bin/sh
          - -c
          - |
            echo "Waiting for Oracle to be ready..."
            until tnsping ${ORACLE_HOST}:${ORACLE_PORT}; do
              echo "Still waiting..."
              sleep 10
            done

            echo "Running initialization SQL..."
            echo "${ORACLE_PASSWORD}" | sqlplus -s sys/${ORACLE_PASSWORD}@//${ORACLE_HOST}:${ORACLE_PORT}/${ORACLE_PDB} as sysdba @/sql/init.sql

        env:
        - name: ORACLE_HOST
          valueFrom:
            configMapKeyRef:
              name: billing-config
              key: ORACLE_HOST
        - name: ORACLE_PORT
          valueFrom:
            configMapKeyRef:
              name: billing-config
              key: ORACLE_PORT
        - name: ORACLE_PDB
          valueFrom:
            configMapKeyRef:
              name: billing-config
              key: ORACLE_PDB
        - name: ORACLE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: ORACLE_PASSWORD

        volumeMounts:
        - name: oracle-sql-volume
          mountPath: /sql

      volumes:
      - name: oracle-sql-volume
        configMap:
          name: oracle-init-sql
          items:
            - key: init.sql
              path: init.sql
